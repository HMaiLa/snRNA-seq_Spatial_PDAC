---
title: "STS_CellphoneDB.Rmd"
author: "Mai La"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Installing packages
```{r cars}
library(Seurat)
library(schex)
library(ggplot2)
library(shiny)
library(dplyr)
library(patchwork)
library(rmarkdown)
library(openxlsx)
```

# Prepare input files
```{r}
sts.simspec.seurat <- readRDS("../sts.simspec_css.sample.sct.Aug24.RDS")
# DietSeurat
DefaultAssay(sts.simspec.seurat) <- "RNA"
sts.simspec.seurat <- DietSeurat(sts.simspec.seurat, assays = "RNA", data = TRUE, counts = TRUE)

# to remove additional columns & because we need to split individual samples and redo the SCT, so we need to remove the "^_SCT"
colnames(sts.simspec.seurat[[]]) #check which columns to remove
sts.simspec.seurat[["nCount_SCT"]] <- NULL
sts.simspec.seurat[["nFeature_SCT"]] <- NULL
sts.simspec.seurat[["seurat_clusters"]] <- NULL
sts.simspec.seurat[["SCT_snn_res.0.8"]] <- NULL
sts.simspec.seurat[["SCT_snn_res.0.9"]] <- NULL
sts.simspec.seurat[["SCT_snn_res.1"]] <- NULL
sts.simspec.seurat[["SCT_snn_res.1.1"]] <- NULL
sts.simspec.seurat[["SCT_snn_res.1.2"]] <- NULL

#Removing outliers
sts.simspec.seurat <- subset(sts.simspec.seurat, subset = Patient_ID %in% c("1959","2185"), invert = T)
sts.simspec.seurat$Patient_ID <- droplevels(sts.simspec.seurat$Patient_ID)

# Removing unwanted cells
sts.simspec.seurat <- subset(sts.simspec.seurat, subset = Lv.2.Anno %in% c("PDA_OLGC","unassigned"), invert=T)

# Downsampling
sts.simspec.seurat
Idents(sts.simspec.seurat) <- "Lv.2.Anno"
sts.seurat <- subset(sts.simspec.seurat, downsample=500) 

# metadata
table(sts.seurat@meta.data$Lv.2.Anno) 
sts.seurat@meta.data$Cell = rownames(sts.seurat@meta.data)
df = sts.seurat@meta.data[,c("Cell","Lv.2.Anno")]
write.table(df, file ='~/CellphoneDB/sts.final.tsv', sep = '\t', quote = F, row.names = F) 

# counts
Idents(sts.seurat) <- "Lv.2.Anno"
DefaultAssay(sts.seurat) <- "RNA"
sts.seurat <- NormalizeData(sts.seurat, normalization.method = "LogNormalize", scale.factor = 10000) #catergorial

sts_counts <- as.data.frame(sts.seurat@assays$RNA@data)
sts_counts <- sts_counts[rowSums(sts_counts[,2:dim(sts_counts)[2]])!=0,] 
sts_counts$gene <- rownames(sts_counts)
rownames(sts_counts) <- NULL 
sts_counts <- sts_counts %>% relocate(gene)
write.table(sts_counts, "~/CellphoneDB/sts_counts.tsv",sep = '\t', quote = F, row.names = F)
saveRDS(sts.seurat, file = "../sts.seurat.simspec.small.RDS")
```

# Codes run in python
```{r}
cellphonedb method statistical_analysis \
sts.final.tsv \
sts_counts.tsv \
--counts-data hgnc_symbol \
--threads 30  \
--output-path sts.simspec.small.out/
```

# Loading CellphoneDB results
```{r}
library(ktplots)
# Importing results
pvals <- read.delim("~/CellphoneDB/sts.simspec.small.out/pvalues.txt", check.names = FALSE)
means <- read.delim("~/CellphoneDB/sts.simspec.small.out/means.txt", check.names = FALSE)
deconvoluted <- read.delim("~/CellphoneDB/sts.simspec.small.out/deconvoluted.txt", check.names = FALSE)
sig.means <- read.delim("~/CellphoneDB/sts.simspec.small.out/significant_means.txt", check.names = FALSE)

# filter the list containing interaction pair with collagen
means.filtered <- means[!grepl("COL*.", means$gene_a), ]
pvals.filtered <- pvals[!grepl("COL*.", pvals$gene_a), ]
decon.filtered <- deconvoluted[!grepl("COL*.", pvals$gene_a), ]

library(Seurat)
sts.seurat.small <- readRDS("../sts.seurat.simspec.small.RDS")
```

# Example PLOTTING
## Tuft & ADM
```{r}
plot_cpdb(cell_type1 = 'Tuft', 
               cell_type2 = 'Acinar-Ductal|Ductal MUC5B+|PDAC',
               scdata = sts.seurat.small,
               idents = 'Lv.2.Anno', 
	             means = means.filtered, 
               pvals = pvals.filtered,
               #gene.family =  c( "chemokines","costimulatory"),
               genes = c("BDNF","FGF2","NTRK2","TNFRSF10A","LGALS9","MDK","MST1","WNT9A","NRG3","SEMA3C"), # these are molecules expressed by Tuft
	             highlight = "black", highlight_size = 0.5,
               keep_significant_only = T) +
small_axis(fontsize =10) + small_grid() + small_guide() + small_legend(fontsize = 5, keysize = 0.6) 
```

```{r}
# to focus on key interactions to plot
ddata <- as.data.frame(d[["data"]])
ddata <- ddata %>% filter(pvals < 0.05) # to make sure they are all significant interactions
data <- ddata %>% filter(scaled_means > 1.0)

# Filter rows with NA interactions & rows with NA P-value
data <- data %>% filter(pvals == "0.001")

df_spread <- tidyr::spread(data[,c(1,2,3)], Var2, scaled_means)
rownames(df_spread) <- df_spread[,1]
df_spread <- df_spread[,-1]

df_spread <- df_spread %>%
  mutate_all(funs(ifelse(is.na(.), 0, .)))

mat <- as.matrix(df_spread)
sum(is.infinite(mat)) # to test that there are no infinite values
sum(is.na(mat))

library(pheatmap)
library(viridisLite)
col <- rev(RColorBrewer::brewer.pal(n = 11, name = "RdBu"))

paletteLength <- 30
col <- colorRampPalette(rev(RColorBrewer::brewer.pal(n = 11, name = "RdBu")))(paletteLength)
myBreaks <- c(seq(min(mat), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(mat)/paletteLength, max(mat), length.out=floor(paletteLength/2)))

phet <- pheatmap(mat, color = viridis(n=50),
                 fontsize = 12,cellheight = 10,border_color = T, 
                 fontsize_row = 11, cutree_cols = 1, cutree_rows = 1,
                 cellwidth =15, scale = "none")
```
